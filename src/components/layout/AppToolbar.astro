---
import Icons from '../icons/Icons.astro';

import FontSelector from "../features/accessibility/FontSelector.astro";
import ZoomControls from "../features/accessibility/ZoomControls.astro";
import ThemeSwitcher from "../features/accessibility/ThemeSwitcher.astro";
---

<header class="
    /* Layout */
    app-toolbar
    sticky
    top-0
    flex
    items-center
    gap-2
    p-2

    /* Style */
    bg-base-200
    border-b
    border-base-300

    /* Z-index */
    z-50
" role="banner">
    <div class="
        /* Layout */
        app-toolbar__brand
        flex
        items-center
        min-w-0
        flex-grow
    ">
        <a href="/" 
            class="
                /* Layout */
                app-toolbar__home-link
                flex
                flex-col
                items-baseline
                gap-1
                min-w-0

                /* Style */
                font-medium
                rounded-sm
                text-decoration-none

                /* Focus */
                outline-none
                focus-visible:outline-primary-content
            " 
            aria-label="Retour à l'accueil">
            <h1 class="
                /* Layout */
                app-toolbar__app-name
                m-0

                /* Style */
                text-primary
                text-2xl
                font-bold
            ">Prisma</h1>
            <span class="
                /* Layout */
                app-toolbar__app-subtitle
                m-0
                pl-2

                /* Style */
                text-primary/80
                text-sm
                font-normal
                text-neutral
            ">Pôle recherche</span>
        </a>
    </div>

    <button 
        class="
            /* Layout */
            app-toolbar__menu-toggle
            btn
            btn-circle
            btn-outline

            /* Responsive */
            md:hidden
        " 
        aria-label="Menu d'accessibilité" 
        aria-expanded="false" 
        aria-controls="accessibility-menu"
        aria-haspopup="true"
    >
        <Icons name="accessibility" aria-hidden="true" />
    </button>

    <div 
        id="accessibility-menu" 
        class="
            /* Layout */
            app-toolbar__accessibility
            items-center
            gap-4
            flex
            p-2

            /* Style */
            bg-base-200
            border-b
            border-base-300

            /* Mobile */
            hidden
            absolute
            top-full
            left-0
            w-full
            flex-col

            /* Desktop */
            md:flex
            md:w-auto
            md:relative
            md:flex-row
            md:border-none
        " 
        role="menu"
        aria-label="Options d'accessibilité"
    >
        <FontSelector />
        <ZoomControls />
        <ThemeSwitcher />
    </div>

    <div class="
        /* Layout */
        app-toolbar__user
    ">
        <button 
            class="
                /* Layout */
                app-toolbar__avatar
                avatar
                btn
                btn-circle
                btn-outline
            " 
            aria-label="Menu utilisateur"
            aria-haspopup="true"
        >
            <Icons name="user" aria-hidden="true" />
        </button>
    </div>
</header>

<script>
    const menuToggle = document.querySelector<HTMLButtonElement>('.app-toolbar__menu-toggle');
    const accessibilityMenu = document.querySelector<HTMLDivElement>('#accessibility-menu');

    if (menuToggle && accessibilityMenu) {
        // Handle menu toggle
        menuToggle.addEventListener('click', () => {
            const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
            menuToggle.setAttribute('aria-expanded', (!isExpanded).toString());
            accessibilityMenu.classList.toggle('hidden', !isExpanded);
        });

        // Handle keyboard navigation
        menuToggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                menuToggle.click();
            }
        });

        // Close menu when clicking outside
        // document.addEventListener('click', (e) => {
        //     const target = e.target as Node;
        //     if (menuToggle && accessibilityMenu && 
        //         !menuToggle.contains(target) && 
        //         !accessibilityMenu.contains(target) && 
        //         !accessibilityMenu.hidden) {
        //         menuToggle.setAttribute('aria-expanded', 'false');
        //         accessibilityMenu.hidden = true;
        //     }
        // });

        // Close menu on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !accessibilityMenu.hidden) {
                menuToggle.setAttribute('aria-expanded', 'false');
                accessibilityMenu.hidden = true;
                menuToggle.focus();
            }
        });

        // Trap focus within the menu when open
        accessibilityMenu.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                const focusableElements = accessibilityMenu.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstFocusable = focusableElements[0] as HTMLElement;
                const lastFocusable = focusableElements[focusableElements.length - 1] as HTMLElement;

                if (e.shiftKey) {
                    if (document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    }
                } else {
                    if (document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            }
        });
    }
</script>

<style>
    /* Styles pour les dropdowns en version mobile */
    @media (max-width: 768px) {
        .dropdown-content {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            padding: 1rem !important;
            z-index: 100 !important;
        }

        /* Ajout d'un header pour les dropdowns en mobile */
        .dropdown-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4rem;
            background: hsl(var(--b2));
            border-bottom: 1px solid hsl(var(--b3));
            z-index: -1;
        }

        /* Style pour le bouton de fermeture */
        .dropdown-content .btn-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1;
        }
    }
</style>
